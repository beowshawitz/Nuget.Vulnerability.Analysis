using Microsoft.Extensions.Caching.Memory;
using Microsoft.Extensions.Configuration;
using Nuget.Vulnerability.Analysis.Core.Clients;
using Nuget.Vulnerability.Analysis.Core.Inbound;
using Nuget.Vulnerability.Analysis.Core.Outbound;

namespace Nuget.Vulnerability.Analysis.Core.Processing
{
	public class NugetProcessor
	{
		private readonly NugetVulnerabilityCache _nugetVulnerabilityCache;
		private readonly IConfiguration _configuration;

		public NugetProcessor(IConfiguration configuration, IMemoryCache memoryCache)
		{
			_nugetVulnerabilityCache = new NugetVulnerabilityCache(memoryCache);
			_configuration = configuration;
		}

		public async Task<AnalysisResult> AnalyzeAsync(AnalysisRequest request, NugetSourceClient nugetSourceClient)
		{
			AnalysisResult result = new AnalysisResult();
			if(await LoadAssemblyDataAsync(nugetSourceClient))
			{
				ProcessRequest(request, result);
			}

			return result;
		}

		private async Task<bool> LoadAssemblyDataAsync(NugetSourceClient nugetSourceClient)
		{
			string? vulnerabilityUri = _configuration.GetSection("NugetResources:VulnerabilityBase").Value;
			try
			{
				return await _nugetVulnerabilityCache.LoadNugetVulnerabilityDataAsync(nugetSourceClient, vulnerabilityUri);
			}
			catch (Exception ex) 
			{
				ApplicationException appEx = new ApplicationException("Unable to retrieve the vulnerability data from Nuget.", ex);
				throw appEx;
			}
		}

		private void ProcessRequest(AnalysisRequest request, AnalysisResult result)
		{
			result.VulnerableAssemblies = new List<NugetAssembly>();
			foreach (AssemblyData d in request.Assemblies)
			{
				var assembly = _nugetVulnerabilityCache.GetVulnerabilities(d);
				if(assembly != null && assembly.HasVulnerabilities)
				{
					result.AddUpdateAssembly(assembly);
				}
			}
		}
	}
}
