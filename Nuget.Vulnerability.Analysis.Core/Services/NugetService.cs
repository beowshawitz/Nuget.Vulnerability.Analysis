using Microsoft.Extensions.Configuration;
using Newtonsoft.Json;
using Nuget.Vulnerability.Analysis.Core.Inbound;
using Nuget.Vulnerability.Analysis.Core.Outbound;
using System.Text;

namespace Nuget.Vulnerability.Analysis.Core.Services
{
	public class NugetService : AzServiceBase
	{
		private readonly string _route;

		public NugetService(HttpClient httpClient, IConfiguration configuration) : base(httpClient, configuration)
		{
			_route = configuration["NugetService:ApiRoute"];
		}

		public async Task<AnalysisResult?> AnalyzeAssemblies(AnalysisRequest req)
		{
			try
			{
				var json = JsonConvert.SerializeObject(req);
				using var content = new StringContent(json, UnicodeEncoding.UTF8, "application/json");
				var response = await _httpClient.PostAsync($"{_route}", content);
				response.EnsureSuccessStatusCode();

				var result = await response.Content.ReadAsStringAsync();
				return JsonConvert.DeserializeObject<AnalysisResult?>(result);
			}
			catch(Exception ex)
			{
				ApplicationException appEx = new ApplicationException("An error occurred while analyzing the assemblies.", ex);
				throw appEx;
			}
		}
	}
}
