
using Microsoft.Extensions.Caching.Memory;
using Nuget.Vulnerability.Analysis.Core.Processing;

namespace Nuget.Vulnerability.Analysis.API
{
	/// <summary>
	/// Executed in the startup pipeline once to preload the Nuget data for use by API calls. Otherwise, the user would be forced to wait while it retrieves it on demand.
	/// </summary>
	public class NugetRetrieverBgService : BackgroundService
	{
		private readonly NugetVulnerabilityCache _nugetVulnerabilityCache;

		public NugetRetrieverBgService(IConfiguration configuration, IMemoryCache memoryCache)
		{
			_nugetVulnerabilityCache = new NugetVulnerabilityCache(configuration, memoryCache);
		}

		protected async override Task ExecuteAsync(CancellationToken stoppingToken)
		{
			try
			{
				await _nugetVulnerabilityCache.LoadNugetVulnerabilityDataAsync();
			}
			catch (Exception ex)
			{
				ApplicationException appEx = new ApplicationException("Unable to retrieve the vulnerability data from Nuget.", ex);
				throw appEx;
			}
		}
	}
}
